<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gallery</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #111; color: white; font-family: 'Outfit', sans-serif; overflow: hidden; }
        .gallery-container { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .photo-card { height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; position: relative; scroll-snap-align: start; background: black; transform: translateZ(0); }
        .full-img { width: 100%; max-height: 80vh; object-fit: contain; }
        .bottom-bar { padding: 20px; background: linear-gradient(to top, black, transparent); position: absolute; bottom: 0; width: 100%; box-sizing: border-box; }
        .actions { display: flex; gap: 30px; margin-bottom: 15px; }
        .act-btn { font-size: 26px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .act-btn span { font-size: 16px; font-weight: 400; color: #ccc; }
        .liked-icon { color: #e74c3c; }

        .comment-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; height: 60vh; background: #fff; color: #333; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 100; transition: bottom 0.3s; display: flex; flex-direction: column; will-change: bottom; }
        .comment-sheet.active { bottom: 0; }
        .sheet-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; color: #2d6a4f;}
        .comments-list { flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; -webkit-overflow-scrolling: touch; }
        .comment-item { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .c-user { font-size: 11px; font-weight: bold; color: #2d6a4f; }
        .comment-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; background: white; }
        .c-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-family:'Outfit'; }
        .c-send { background: #2d6a4f; color: white; border: none; padding: 0 15px; border-radius: 20px; cursor: pointer; font-family:'Outfit';}
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 50; }
    </style>
</head>
<body>

<div class="close-btn" onclick="window.location.href='index.html'">&times;</div>
<div class="gallery-container" id="gallery-feed"></div>

<div class="comment-sheet" id="comment-sheet">
    <div class="sheet-header">
        <span id="sheet-title">Comments</span>
        <div onclick="closeComments()" style="cursor:pointer; padding:0 10px;">&times;</div>
    </div>
    <div class="comments-list" id="comments-list"></div>
    <div class="comment-input-area">
        <input type="text" class="c-input" id="c-input" placeholder="Type a comment...">
        <button class="c-send" onclick="postComment()">Post</button>
    </div>
</div>

<script src="data.js"></script>
<script>
    const container = document.getElementById('gallery-feed');
    const currentId = new URLSearchParams(window.location.search).get('id');
    let activePhotoId = null;

    const sortedPhotos = [...db.photos.filter(p => p.id == currentId), ...db.photos.filter(p => p.id != currentId)];

    // OPTIMIZATION: Render all HTML at once
    let renderHTML = '';
    sortedPhotos.forEach(p => {
        if(!p.likes) p.likes = 0; if(!p.commentsList) p.commentsList = []; if(!p.isLiked) p.isLiked = false;
        let likeClass = p.isLiked ? 'liked-icon' : ''; let heartType = p.isLiked ? '‚ù§Ô∏è' : 'ü§ç';

        renderHTML += `
        <div class="photo-card" ondblclick="toggleLike(${p.id})">
            <img src="${p.image}" class="full-img" loading="lazy">
            <div class="bottom-bar">
                <div class="actions">
                    <div class="act-btn" onclick="toggleLike(${p.id})">
                        <i id="icon-${p.id}" class="${likeClass}">${heartType}</i> <span id="likes-${p.id}">${p.likes}</span>
                    </div>
                    <div class="act-btn" onclick="openComments(${p.id})">
                        <i>üí¨</i> <span id="comm-${p.id}">${p.commentsList.length}</span>
                    </div>
                    <div class="act-btn" onclick="sharePhoto(${p.id})"><i>üöÄ</i></div>
                </div>
                <div style="font-size:16px; font-weight:600;">${p.title || 'Photo'}</div>
            </div>
        </div>`;
    });
    container.innerHTML = renderHTML;

    function toggleLike(id) {
        const p = db.photos.find(x => x.id == id); const icon = document.getElementById(`icon-${id}`); const count = document.getElementById(`likes-${id}`);
        if(!p.isLiked) { p.likes++; p.isLiked = true; icon.innerText = '‚ù§Ô∏è'; icon.classList.add('liked-icon'); } 
        else { p.likes--; p.isLiked = false; icon.innerText = 'ü§ç'; icon.classList.remove('liked-icon'); }
        count.innerText = p.likes; saveData();
    }

    function sharePhoto(id) {
        const p = db.photos.find(x => x.id == id);
        if (navigator.share) { navigator.share({ title: p.title, url: window.location.href }); } else { alert("Link copied!"); }
    }

    function openComments(id) {
        activePhotoId = id; const p = db.photos.find(x => x.id == id); const list = document.getElementById('comments-list');
        if(p.commentsList.length === 0) list.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>No comments yet.</div>";
        else list.innerHTML = p.commentsList.map(c => `<div class="comment-item"><div class="c-user">Guest</div><div>${c}</div></div>`).join('');
        document.getElementById('sheet-title').innerText = `Comments (${p.commentsList.length})`; document.getElementById('comment-sheet').classList.add('active');
    }
    function closeComments() { document.getElementById('comment-sheet').classList.remove('active'); }
    function postComment() {
        const input = document.getElementById('c-input'); if(!input.value.trim()) return;
        const p = db.photos.find(x => x.id == activePhotoId); p.commentsList.push(input.value.trim()); saveData();
        input.value = ""; openComments(activePhotoId); document.getElementById(`comm-${activePhotoId}`).innerText = p.commentsList.length;
    }
</script>
</body>
</html>