<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gallery - Mundari Samaj</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #9c3f1b; 
            --primary-light: #d66b45; 
            --bg-dark: #000000; 
            --text-light: #ffffff; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: var(--bg-dark); color: var(--text-light); 
            font-family: 'Outfit', sans-serif; overflow: hidden; 
        }

        /* --- HEADER BACK BUTTON --- */
        .header-back {
            position: fixed; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            padding: 10px 18px; border-radius: 50px; text-decoration: none;
            color: white; font-weight: 500; font-size: 15px;
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.15);
        }

        /* --- FEED SCROLLING --- */
        .gallery-container {
            height: 100vh; height: 100dvh; width: 100%;
            overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth;
        }
        .gallery-container::-webkit-scrollbar { display: none; } 

        .photo-card {
            height: 100vh; height: 100dvh; width: 100%;
            scroll-snap-align: start; scroll-snap-stop: always; 
            position: relative; background: #000000;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* --- NEW: AMBIENT GLOW BACKGROUND --- */
        .ambient-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(70px) saturate(200%) brightness(0.6); /* Creates the deep color glow */
            transform: scale(1.2); /* Hides hard edges from the blur */
            z-index: 0;
            animation: ambientPulse 12s infinite alternate ease-in-out;
        }
        @keyframes ambientPulse {
            0% { transform: scale(1.2) translate(0, 0); }
            50% { transform: scale(1.4) translate(-2%, 2%); }
            100% { transform: scale(1.3) translate(2%, -2%); }
        }

        .full-img { width: 100%; max-height: 100vh; object-fit: contain; pointer-events: none; z-index: 5; position: relative; }

        /* --- INTERACTION OVERLAY --- */
        .glass-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        .big-heart {
            position: absolute; color: #e74c3c;
            opacity: 0; transform: scale(0); z-index: 20;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        .big-heart svg { width: 100px; height: 100px; fill: #e74c3c; stroke: #e74c3c; stroke-width: 1; }
        @keyframes heartPop { 
            0% { transform: scale(0) rotate(-10deg); opacity: 0; } 
            15% { transform: scale(1.3) rotate(5deg); opacity: 1; } 
            30% { transform: scale(1) rotate(0deg); opacity: 1; } 
            80% { transform: scale(1) translateY(0); opacity: 1; } 
            100% { transform: scale(1.5) translateY(-40px); opacity: 0; } 
        }
        .heart-animating { animation: heartPop 0.9s forwards; }

        /* --- INFO SECTION --- */
        .info-section { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%); 
            padding: 60px 70px 30px 20px; box-sizing: border-box; z-index: 20; pointer-events: none; 
            transition: opacity 0.3s ease;
        }
        .photo-user { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; pointer-events: auto;}
        .photo-user img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }
        .photo-title { font-family: 'Outfit', sans-serif; font-size: 16px; font-weight: 400; color: #ffffff; margin: 0; line-height: 1.4; text-shadow: 0 1px 4px rgba(0,0,0,0.8); pointer-events: auto;}

        /* --- RIGHT SIDE ACTIONS BAR (Matched to video.html) --- */
        .right-actions {
            position: absolute; right: 15px; bottom: 40px; z-index: 25;
            display: flex; flex-direction: column; gap: 20px; pointer-events: auto;
            transition: opacity 0.3s ease;
        }
        .action-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-decoration: none; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
            cursor: pointer; transition: transform 0.2s;
        }
        .action-btn:active { transform: scale(0.85); }
        .btn-circle {
            background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.15); margin-bottom: 5px; transition: 0.3s;
        }
        .action-btn span { font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); letter-spacing: 0.5px; }
        .action-btn svg { width: 22px; height: 22px; stroke: white; stroke-width: 2; fill: none; transition: 0.3s; }
        
        .action-btn.liked .btn-circle { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .action-btn.liked svg { fill: #e74c3c; stroke: #e74c3c; }

        /* --- COMING SOON COMMENT SHEET --- */
        .comment-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; visibility: hidden; transition: 0.3s ease; }
        .comment-overlay.active { opacity: 1; visibility: visible; }

        .comment-sheet { 
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 50vh; 
            background: #fff; color: #333; border-radius: 24px 24px 0 0; 
            z-index: 100; transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        }
        .comment-sheet.active { bottom: 0; }
        .sheet-header { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .sheet-header span { font-weight: 700; font-size: 18px; color: var(--primary); }
        .close-comments { background: #f0f0f0; width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #555; }

        .comments-list { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; padding: 20px; text-align: center; }
        .coming-soon-msg { font-size: 18px; font-weight: 600; color: #555; line-height: 1.5; }
        .coming-soon-msg span { display: block; font-size: 30px; margin-top: 10px; }

        /* --- END SCREEN --- */
        .end-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1a0b05 0%, #000000 100%);
            text-align: center; padding: 30px; z-index: 50; position: relative;
        }
        .end-title { font-family: 'Cormorant Garamond', serif; font-size: 42px; color: var(--primary); margin-bottom: 10px; }
        .end-text { font-size: 16px; color: #aaa; max-width: 300px; line-height: 1.5; }
        .back-top-btn {
            margin-top: 30px; padding: 12px 24px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50px;
            color: white; font-weight: 600; cursor: pointer; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <a href="index.html" class="header-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
    </a>

    <div class="gallery-container" id="gallery-feed"></div>

    <div class="comment-overlay" id="comment-overlay" onclick="closeComments()"></div>
    <div class="comment-sheet" id="comment-sheet">
        <div class="sheet-header">
            <span id="sheet-title">Comments</span>
            <div class="close-comments" onclick="closeComments()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        <div class="comments-list" id="comments-list">
            <div class="coming-soon-msg">
                Comment page will be coming soon thanx 
                <span>ðŸ’—</span>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        const container = document.getElementById('gallery-feed');
        const currentId = new URLSearchParams(window.location.search).get('id');
        let feedPhotos = [];

        // --- BULLETPROOF LOGO LOGIC ---
        const fallbackLogo = "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%239c3f1b' width='100' height='100'/%3E%3Ctext fill='%23ffffff' x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='50' font-family='sans-serif'%3EM%3C/text%3E%3C/svg%3E";
        let currentLogo = fallbackLogo;
        
        if (typeof db !== 'undefined' && db.admin && db.admin.logo && db.admin.logo.length > 5) {
            currentLogo = db.admin.logo;
        }

        if (typeof db !== 'undefined' && db.photos) {
            feedPhotos = [...db.photos];
            
            let targetPhoto = null;
            if(currentId) {
                const targetIdx = feedPhotos.findIndex(p => p.id == currentId);
                if(targetIdx > -1) {
                    targetPhoto = feedPhotos.splice(targetIdx, 1)[0];
                }
            }

            // Shuffle the rest of the feed
            for (let i = feedPhotos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [feedPhotos[i], feedPhotos[j]] = [feedPhotos[j], feedPhotos[i]];
            }

            if(targetPhoto) feedPhotos.unshift(targetPhoto);
        }

        if (feedPhotos.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding-top:40vh; font-size:20px;">No photos found.</div>`;
        } else {
            let renderHTML = '';
            feedPhotos.forEach(p => {
                if(!p.likes) p.likes = 0; 
                if(!p.isLiked) p.isLiked = false;
                
                let likeClass = p.isLiked ? 'liked' : '';

                renderHTML += `
                <div class="photo-card" id="card_${p.id}">
                    
                    <div class="ambient-bg" style="background-image: url('${p.image}');"></div>
                    
                    <div class="glass-overlay" onclick="handleTap(event, '${p.id}')">
                        <div class="big-heart" id="big_heart_${p.id}">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </div>
                        <img src="${p.image}" class="full-img" loading="lazy">
                    </div>

                    <div class="right-actions ui-element_${p.id}">
                        <div class="action-btn ${likeClass}" id="btn_like_${p.id}" onclick="toggleLike('${p.id}')">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            </div>
                            <span>Like</span>
                        </div>
                        
                        <div class="action-btn" onclick="openComments()">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <span>Comment</span>
                        </div>

                        <div class="action-btn" onclick="sharePhoto('${p.id}')">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </div>
                            <span>Share</span>
                        </div>

                        <a href="${p.image}" target="_blank" download class="action-btn" onclick="event.stopPropagation();">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </div>
                            <span>Save</span>
                        </a>
                    </div>

                    <div class="info-section ui-element_${p.id}">
                        <div class="photo-user">
                            <img src="${currentLogo}" onerror="this.onerror=null; this.src='${fallbackLogo}';"> Mundari Samaj
                        </div>
                        <p class="photo-title">${p.title || 'Beautiful Mundari Culture'}</p>
                    </div>

                </div>`;
            });

            // End Screen
            renderHTML += `
            <div class="photo-card end-screen">
                <h2 class="end-title">Johar!</h2>
                <div class="end-text">Thanks for viewing our gallery. More beautiful photos are coming soon.</div>
                <div class="back-top-btn" onclick="document.getElementById('gallery-feed').scrollTo({top:0, behavior:'smooth'})">â†‘ Back to Top</div>
            </div>`;

            container.innerHTML = renderHTML;
        }

        // --- SMART INTERACTION LOGIC ---
        let tapTimeout = null;
        let lastTapTime = 0;

        function handleTap(e, id) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;

            if (tapLength < 300 && tapLength > 0) {
                clearTimeout(tapTimeout); // Cancel single tap
                
                // Double Tap Logic
                const heart = document.getElementById(`big_heart_${id}`);
                heart.classList.remove('heart-animating');
                void heart.offsetWidth; 
                heart.classList.add('heart-animating');

                const p = db.photos.find(x => x.id == id);
                if(p && !p.isLiked) toggleLike(id);
                
            } else {
                // Single Tap Logic: Hide/Show UI for clean viewing
                tapTimeout = setTimeout(() => {
                    toggleOverlayUI(id);
                }, 300);
            }
            lastTapTime = currentTime;
        }

        function toggleOverlayUI(id) {
            const elements = document.querySelectorAll(`.ui-element_${id}`);
            elements.forEach(el => {
                if(el.style.opacity === '0') {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                } else {
                    el.style.opacity = '0';
                    el.style.pointerEvents = 'none';
                }
            });
        }

        // --- ACTIONS ---
        function toggleLike(id) {
            const p = db.photos.find(x => x.id == id); 
            const btn = document.getElementById(`btn_like_${id}`); 
            
            if(!p.isLiked) { 
                p.likes++; p.isLiked = true; btn.classList.add('liked'); 
            } else { 
                p.likes--; p.isLiked = false; btn.classList.remove('liked'); 
            }
            if(typeof saveData === 'function') saveData();
        }

        function sharePhoto(id) {
            const p = db.photos.find(x => x.id == id);
            if (navigator.share) { navigator.share({ title: p.title || 'Mundari Samaj Photo', url: window.location.href }); } 
            else { alert("Link copied to clipboard!"); }
        }

        // --- COMMENTS (COMING SOON) ---
        function openComments() {
            document.getElementById('comment-sheet').classList.add('active');
            document.getElementById('comment-overlay').classList.add('active');
        }

        function closeComments() { 
            document.getElementById('comment-sheet').classList.remove('active'); 
            document.getElementById('comment-overlay').classList.remove('active'); 
        }
    </script>
</body>
</html>