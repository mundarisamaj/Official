<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Reels - Mundari Samaj</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --vlc-orange: #FF7F00; 
            --bg-dark: #000000; 
            --text-light: #ffffff; 
            --primary: #9c3f1b; 
            --primary-light: #d66b45; 
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: var(--bg-dark); color: var(--text-light); 
            font-family: 'Outfit', sans-serif; overflow: hidden; 
        }

        .header-back {
            position: fixed; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            padding: 10px 18px; border-radius: 50px; text-decoration: none;
            color: white; font-weight: 500; font-size: 15px;
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.15);
        }

        .feed-container {
            height: 100vh; height: 100dvh; width: 100%;
            overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth;
        }
        .feed-container::-webkit-scrollbar { display: none; } 

        .feed-item {
            height: 100vh; height: 100dvh; width: 100%;
            scroll-snap-align: start; scroll-snap-stop: always; 
            position: relative; background: #050505;
        }

        /* Video Area */
        .video-section { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .player-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; background: #000;}

        iframe, video {
            width: 100%; height: 100%; border: none; 
            object-fit: cover; pointer-events: none; 
        }

        .ig-iframe { 
            pointer-events: auto !important; width: 100%; height: 100%; 
            max-width: 500px; background: #000;
        }

        .glass-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        /* --- LOADING SPINNER --- */
        .yt-spinner {
            width: 45px; height: 45px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--vlc-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%;
            margin-top: -22.5px; margin-left: -22.5px; 
            z-index: 999; display: none; pointer-events: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Icon overlays */
        .center-icon {
            width: 70px; height: 70px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.8); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transform: scale(0.5); transition: 0.2s ease-out;
            position: absolute; top: 50%; left: 50%; margin-top: -35px; margin-left: -35px;
        }
        .center-icon.show { opacity: 1; transform: scale(1); }
        .center-icon svg { width: 35px; height: 35px; fill: white; }
        
        .error-text { font-size: 11px; font-weight: 600; text-align: center; line-height: 1.2; color: #ff4d4d; }

        /* --- DOUBLE TAP ANIMATIONS --- */
        .heart-icon {
            position: absolute; color: #e74c3c;
            opacity: 0; transform: scale(0); z-index: 20;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        .heart-icon svg { width: 100px; height: 100px; fill: #e74c3c; stroke: #e74c3c; }
        @keyframes heartPop { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 15% { transform: scale(1.3) rotate(5deg); opacity: 1; } 30% { transform: scale(1) rotate(0deg); opacity: 1; } 80% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(1.5) translateY(-40px); opacity: 0; } }
        .heart-animating { animation: heartPop 0.9s forwards; }

        .skip-indicator {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.6); color: white; padding: 12px 20px; border-radius: 30px;
            font-size: 16px; font-weight: bold; opacity: 0; pointer-events: none; z-index: 50;
        }
        .skip-left { left: 15%; }
        .skip-right { right: 15%; }
        .skip-anim { animation: skipFade 0.6s ease-out; }
        @keyframes skipFade { 0% { opacity: 1; transform: translateY(-50%) scale(0.9); } 50% { opacity: 1; transform: translateY(-50%) scale(1.1); } 100% { opacity: 0; transform: translateY(-50%) scale(1); } }

        /* --- INFO SECTION --- */
        .info-section { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%); padding: 80px 80px 35px 20px; box-sizing: border-box; z-index: 20; pointer-events: none; }
        .photo-user { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; pointer-events: auto; }
        .photo-user img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }
        .vid-title { font-family: 'Outfit', sans-serif; font-size: 18px; font-weight: 600; color: #ffffff; margin: 0 0 8px 0; line-height: 1.3; text-shadow: 0 2px 5px rgba(0,0,0,0.8); pointer-events: auto; }
        .vid-desc { font-size: 13px; opacity: 0.9; line-height: 1.5; text-shadow: 0 1px 4px rgba(0,0,0,0.8); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; pointer-events: auto; }

        /* --- RIGHT SIDE ACTIONS BAR --- */
        .right-actions {
            position: absolute; right: 15px; bottom: 50px; z-index: 25;
            display: flex; flex-direction: column; gap: 20px;
            pointer-events: auto;
        }
        .action-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-decoration: none; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
            cursor: pointer; transition: transform 0.2s;
        }
        .action-btn:active { transform: scale(0.85); }
        .btn-circle {
            background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.15); margin-bottom: 5px; transition: 0.3s;
        }
        .action-btn span { font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); letter-spacing: 0.5px; }
        .action-btn svg { width: 22px; height: 22px; stroke: white; stroke-width: 2; fill: none; transition: 0.3s; }
        
        .action-btn.liked .btn-circle { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .action-btn.liked svg { fill: #e74c3c; stroke: #e74c3c; }

        /* --- COMING SOON COMMENT SHEET --- */
        .comment-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; visibility: hidden; transition: 0.3s ease; }
        .comment-overlay.active { opacity: 1; visibility: visible; }

        .comment-sheet { 
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 50vh; 
            background: #fff; color: #333; border-radius: 24px 24px 0 0; 
            z-index: 100; transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        }
        .comment-sheet.active { bottom: 0; }
        .sheet-header { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .sheet-header span { font-weight: 700; font-size: 18px; color: var(--primary); }
        .close-comments { background: #f0f0f0; width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #555; }

        .comments-list { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; padding: 20px; text-align: center; }
        .coming-soon-msg { font-size: 18px; font-weight: 600; color: #555; line-height: 1.5; }
        .coming-soon-msg span { display: block; font-size: 30px; margin-top: 10px; }

        /* --- PROGRESS BAR --- */
        .vlc-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; display: flex; align-items: flex-end; z-index: 30; cursor: pointer; }
        .vlc-progress { width: 100%; height: 3px; background: rgba(255,255,255,0.3); transition: height 0.1s; }
        .vlc-progress-container:active .vlc-progress { height: 8px; }
        .vlc-progress-bar { height: 100%; background: var(--vlc-orange); width: 0%; pointer-events: none; position: relative; }
        .vlc-progress-bar::after { content: ''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s; }
        .vlc-progress-container:active .vlc-progress-bar::after { opacity: 1; }

        /* --- END SCREEN --- */
        .end-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1a0b05 0%, #000000 100%);
            text-align: center; padding: 30px;
        }
        .end-title { font-family: 'Cormorant Garamond', serif; font-size: 42px; color: var(--primary); margin-bottom: 10px; }
        .end-text { font-size: 16px; color: #aaa; max-width: 300px; line-height: 1.5; }
        .back-top-btn {
            margin-top: 30px; padding: 12px 24px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50px;
            color: white; font-weight: 600; cursor: pointer; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <a href="index.html" class="header-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
    </a>

    <div class="feed-container" id="feed-container"></div>

    <div class="comment-overlay" id="comment-overlay" onclick="closeComments()"></div>
    <div class="comment-sheet" id="comment-sheet">
        <div class="sheet-header">
            <span id="sheet-title">Comments</span>
            <div class="close-comments" onclick="closeComments()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        <div class="comments-list" id="comments-list">
            <div class="coming-soon-msg">
                Comment page will be coming soon thanx 
                <span>üíó</span>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="data.js"></script>
    <script>
        const feedContainer = document.getElementById('feed-container');
        let ytPlayers = {}; 
        let htmlPlayers = {}; 
        let playState = {}; 

        // --- NEW: BULLETPROOF LOGO LOGIC ---
        const fallbackLogo = "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%239c3f1b' width='100' height='100'/%3E%3Ctext fill='%23ffffff' x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='50' font-family='sans-serif'%3EM%3C/text%3E%3C/svg%3E";
        let currentLogo = fallbackLogo;
        
        // Dynamically pull the admin logo if it exists
        if (typeof db !== 'undefined' && db.admin && db.admin.logo && db.admin.logo.length > 5) {
            currentLogo = db.admin.logo;
        }

        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getInstagramEmbed(url) {
            if (url.includes('instagram.com')) {
                return url.split('?')[0].replace(/\/$/, "") + "/embed";
            }
            return null;
        }

        let feedVideos = [];
        if (typeof db !== 'undefined' && db.videos) {
            feedVideos = [...db.videos];
            const urlParams = new URLSearchParams(window.location.search);
            const reqId = parseInt(urlParams.get('id'));
            
            let targetVid = null;
            if(reqId) {
                const targetIdx = feedVideos.findIndex(v => v.id === reqId);
                if(targetIdx > -1) {
                    targetVid = feedVideos.splice(targetIdx, 1)[0];
                }
            }

            // SHUFFLE LOGIC
            for (let i = feedVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [feedVideos[i], feedVideos[j]] = [feedVideos[j], feedVideos[i]];
            }

            if (targetVid) feedVideos.unshift(targetVid);
        }

        if (feedVideos.length === 0) {
            feedContainer.innerHTML = `<div style="text-align:center; padding-top:40vh; font-size:20px;">No videos found.</div>`;
        } else {
            let htmlContent = '';
            feedVideos.forEach((video) => {
                const ytId = getYouTubeId(video.link);
                const igUrl = getInstagramEmbed(video.link);
                const isYt = !!ytId;
                const isIg = !!igUrl;
                const safeDesc = "Experience this amazing moment from the Mundari Samaj community. Scroll down for more!";
                
                const posterAttr = (video.thumbnail && video.thumbnail.trim() !== '') ? `poster="${video.thumbnail}"` : '';

                // Initialize Data
                if(!video.likes) video.likes = 0; 
                if(!video.isLiked) video.isLiked = false;
                
                let likeClass = video.isLiked ? 'liked' : '';
                
                // For YouTube videos, replace "Save" with "Fullscreen"
                let finalActionBtn = !isYt ? `
                    <a href="${video.link}" target="_blank" download class="action-btn" onclick="event.stopPropagation();">
                        <div class="btn-circle">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </div>
                        <span>Save</span>
                    </a>
                ` : `
                    <div class="action-btn" onclick="toggleFullscreen('wrapper_${video.id}', event)">
                        <div class="btn-circle">
                            <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                        </div>
                        <span>Full</span>
                    </div>
                `;

                htmlContent += `
                <div class="feed-item" data-id="vid_${video.id}" data-yt="${isYt}" data-ig="${isIg}">
                    <div class="video-section">
                        <div class="player-wrapper" id="wrapper_${video.id}">
                            ${isYt 
                                ? `<iframe id="ytplayer_${video.id}" class="yt-iframe" src="https://www.youtube.com/embed/${ytId}?enablejsapi=1&autoplay=0&controls=0&disablekb=1&fs=0&modestbranding=1&rel=0&showinfo=0&playsinline=1&iv_load_policy=3" allow="autoplay; encrypted-media; fullscreen"></iframe>` 
                                : isIg 
                                ? `<iframe id="igplayer_${video.id}" class="ig-iframe" src="${igUrl}" frameborder="0" scrolling="no" allowtransparency="true" sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>`
                                : `<video id="htmlplayer_${video.id}" src="${video.link}" type="video/mp4" ${posterAttr} loop playsinline webkit-playsinline preload="metadata"></video>`
                            }
                            
                            <div class="yt-spinner" id="spinner_${video.id}"></div>

                            ${!isIg ? `
                            <div class="glass-overlay" id="overlay_${video.id}" onclick="handleTap(event, '${video.id}', ${isYt})">
                                <div class="heart-icon" id="heart_${video.id}">
                                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                </div>
                                <div class="skip-indicator skip-left" id="skip_left_${video.id}">‚è™ 5s</div>
                                <div class="skip-indicator skip-right" id="skip_right_${video.id}">‚è© 5s</div>
                                
                                <div class="center-icon" id="icon_${video.id}">
                                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${!isIg ? `
                    <div class="right-actions">
                        <div class="action-btn ${likeClass}" id="btn_like_${video.id}" onclick="toggleLike('${video.id}')">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            </div>
                            <span>Like</span>
                        </div>
                        
                        <div class="action-btn" onclick="openComments()">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <span>Comment</span>
                        </div>

                        <div class="action-btn" onclick="shareVideo('${video.id}')">
                            <div class="btn-circle">
                                <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </div>
                            <span>Share</span>
                        </div>

                        ${finalActionBtn}
                    </div>
                    ` : ''}

                    <div class="info-section" style="${isIg ? 'pointer-events: none; opacity: 0.8;' : ''}">
                        <div class="photo-user">
                            <img src="${currentLogo}" onerror="this.onerror=null; this.src='${fallbackLogo}';"> Mundari Samaj
                        </div>
                        <h2 class="vid-title">${video.title || 'Mundari Video'}</h2>
                        <div class="vid-desc">${safeDesc}</div>
                    </div>

                    ${!isIg ? `
                    <div class="vlc-progress-container" id="progContainer_${video.id}" onclick="seekVideoUI(event, '${video.id}', ${isYt})" ontouchmove="seekVideoUI(event, '${video.id}', ${isYt})">
                        <div class="vlc-progress"><div class="vlc-progress-bar" id="progress_${video.id}"></div></div>
                    </div>
                    ` : ''}
                </div>`;
            });

            htmlContent += `
            <div class="feed-item end-screen">
                <h2 class="end-title">Johar!</h2>
                <div class="end-text">Thanks for watching. More amazing cultural videos are coming soon.</div>
                <div class="back-top-btn" onclick="document.getElementById('feed-container').scrollTo({top:0, behavior:'smooth'})">‚Üë Back to Top</div>
            </div>`;

            feedContainer.innerHTML = htmlContent;
        }

        // Initialize Native HTML5 Players
        document.querySelectorAll('video').forEach(el => {
            const dbId = el.id.split('_')[1];
            htmlPlayers[dbId] = el;
            
            el.addEventListener('timeupdate', () => {
                if(el.duration) {
                    const progress = (el.currentTime / el.duration) * 100;
                    document.getElementById(`progress_${dbId}`).style.width = progress + '%';
                }
            });

            const spinner = document.getElementById(`spinner_${dbId}`);
            el.addEventListener('loadstart', () => { if(spinner) spinner.style.display = 'block'; });
            el.addEventListener('waiting', () => { if(spinner) spinner.style.display = 'block'; });
            el.addEventListener('playing', () => { if(spinner) spinner.style.display = 'none'; });
            el.addEventListener('canplay', () => { if(spinner) spinner.style.display = 'none'; });
            
            el.addEventListener('error', () => {
                if(spinner) spinner.style.display = 'none';
                const icon = document.getElementById(`icon_${dbId}`);
                if(icon) {
                    icon.innerHTML = `<div class="error-text">Server Error<br>Tap to Open</div>`;
                    icon.style.borderColor = "#ff4d4d";
                    icon.classList.add('show');
                }
                el.dataset.error = "true";
            });
        });

        // Initialize YT Players
        function onYouTubeIframeAPIReady() {
            document.querySelectorAll('.yt-iframe').forEach(el => {
                const dbId = el.id.split('_')[1];
                ytPlayers[dbId] = new YT.Player(el.id, {
                    events: {
                        'onStateChange': function(event) {
                            const spinner = document.getElementById(`spinner_${dbId}`);
                            if (!spinner) return;
                            if (event.data == 3) { spinner.style.display = 'block'; } 
                            else if (event.data == 1 || event.data == 2) { spinner.style.display = 'none'; }
                        }
                    }
                });
            });
        }

        setInterval(() => {
            for (let id in playState) {
                if (playState[id] && ytPlayers[id] && typeof ytPlayers[id].getCurrentTime === 'function') {
                    const duration = ytPlayers[id].getDuration();
                    if (duration > 0) {
                        const prog = (ytPlayers[id].getCurrentTime() / duration) * 100;
                        document.getElementById(`progress_${id}`).style.width = prog + '%';
                    }
                }
            }
        }, 150);

        function seekVideoUI(e, id, isYt) {
            e.stopPropagation(); 
            const container = document.getElementById(`progContainer_${id}`);
            const rect = container.getBoundingClientRect();
            let clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            if(e.type === 'touchmove') e.preventDefault(); 

            let percentage = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width)); 
            document.getElementById(`progress_${id}`).style.width = (percentage * 100) + '%';
            
            if (isYt && ytPlayers[id] && typeof ytPlayers[id].getDuration === 'function') {
                ytPlayers[id].seekTo(percentage * ytPlayers[id].getDuration(), true);
            } else if (!isYt && htmlPlayers[id] && htmlPlayers[id].duration) {
                htmlPlayers[id].currentTime = percentage * htmlPlayers[id].duration;
            }
        }

        // --- SMART TAP SYSTEM (Single Tap = Pause, Double Tap = Skip/Like) ---
        let tapTimeout = null;
        let lastTapTime = 0;

        function handleTap(e, id, isYt) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;

            if (tapLength < 300 && tapLength > 0) {
                clearTimeout(tapTimeout); 
                
                const screenWidth = window.innerWidth;
                
                if (e.clientX < screenWidth * 0.35) {
                    skipTime(id, isYt, -5);
                    showSkipAnimation(id, 'left');
                } else if (e.clientX > screenWidth * 0.65) {
                    skipTime(id, isYt, 5);
                    showSkipAnimation(id, 'right');
                } else {
                    const heart = document.getElementById(`heart_${id}`);
                    heart.classList.remove('heart-animating');
                    void heart.offsetWidth; 
                    heart.classList.add('heart-animating');
                    
                    const v = db.videos.find(x => x.id == id);
                    if(v && !v.isLiked) toggleLike(id);
                }
            } else {
                tapTimeout = setTimeout(() => {
                    togglePlay(id, isYt);
                }, 300);
            }
            lastTapTime = currentTime;
        }

        function skipTime(id, isYt, seconds) {
            if (isYt && ytPlayers[id] && typeof ytPlayers[id].getCurrentTime === 'function') {
                const ct = ytPlayers[id].getCurrentTime();
                ytPlayers[id].seekTo(ct + seconds, true);
            } else if (!isYt && htmlPlayers[id]) {
                htmlPlayers[id].currentTime += seconds;
            }
        }

        function showSkipAnimation(id, direction) {
            const el = document.getElementById(`skip_${direction}_${id}`);
            el.classList.remove('skip-anim');
            void el.offsetWidth; 
            el.classList.add('skip-anim');
        }

        // --- YOUTUBE LANDSCAPE FULLSCREEN LOGIC ---
        function toggleFullscreen(wrapperId, event) {
            if(event) event.stopPropagation();
            const elem = document.getElementById(wrapperId);
            
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.log(err));
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
                
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        }

        // --- ACTIONS LOGIC ---
        function toggleLike(id) {
            const v = db.videos.find(x => x.id == id); 
            const btn = document.getElementById(`btn_like_${id}`); 
            
            if(!v.isLiked) { 
                v.likes++; v.isLiked = true; btn.classList.add('liked'); 
            } else { 
                v.likes--; v.isLiked = false; btn.classList.remove('liked'); 
            }
            if(typeof saveData === 'function') saveData();
        }

        function shareVideo(id) {
            const v = db.videos.find(x => x.id == id);
            if (navigator.share) { navigator.share({ title: v.title || 'Mundari Video', url: window.location.href }); } 
            else { alert("Link copied to clipboard!"); }
        }

        // --- COMMENTS LOGIC (COMING SOON MESSAGE) ---
        function openComments() {
            document.getElementById('comment-sheet').classList.add('active');
            document.getElementById('comment-overlay').classList.add('active');
        }

        function closeComments() { 
            document.getElementById('comment-sheet').classList.remove('active'); 
            document.getElementById('comment-overlay').classList.remove('active'); 
        }

        // --- PLAY/PAUSE LOGIC ---
        function togglePlay(id, isYt) {
            if (playState[id]) forcePause(id, isYt);
            else forcePlay(id, isYt);
        }

        function forcePlay(id, isYt) {
            playState[id] = true;
            const icon = document.getElementById(`icon_${id}`);
            icon.classList.remove('show');
            const spinner = document.getElementById(`spinner_${id}`);
            
            if (isYt) {
                if (spinner) spinner.style.display = 'block'; 
                if (ytPlayers[id] && typeof ytPlayers[id].playVideo === 'function') {
                    ytPlayers[id].playVideo();
                } else {
                    const iframe = document.getElementById(`ytplayer_${id}`);
                    if(iframe) iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                }
            } else if (htmlPlayers[id]) {
                const vid = htmlPlayers[id];
                
                if (vid.dataset.error === "true") {
                    window.open(vid.src, '_blank');
                    playState[id] = false;
                    return;
                }

                if (vid.readyState < 3 && spinner) {
                    spinner.style.display = 'block';
                }
                
                const playPromise = vid.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        playState[id] = false;
                        if (spinner) spinner.style.display = 'none';
                        icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
                        icon.classList.add('show');
                    });
                }
            }
        }

        function forcePause(id, isYt) {
            playState[id] = false;
            const icon = document.getElementById(`icon_${id}`);
            if(!icon) return; 
            icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            icon.classList.add('show');
            if (isYt) {
                const iframe = document.getElementById(`ytplayer_${id}`);
                if(iframe) iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            } else if (htmlPlayers[id]) {
                htmlPlayers[id].pause();
            }
        }

        // FULL AUTO-PLAY SYSTEM
        const feedObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const idRaw = entry.target.dataset.id;
                if (!idRaw) return; 

                const id = idRaw.replace('vid_', '');
                const isYt = entry.target.dataset.yt === 'true';
                const isIg = entry.target.dataset.ig === 'true';

                if (isIg) return; 

                if (entry.isIntersecting) {
                    forcePlay(id, isYt);
                } else {
                    forcePause(id, isYt);
                }
            });
        }, { root: feedContainer, threshold: 0.6 });

        document.querySelectorAll('.feed-item').forEach(item => feedObserver.observe(item));

    </script>
</body>
</html>