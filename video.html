<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Reels - Mundari Samaj</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --vlc-orange: #FF7F00; --bg-dark: #000000; --text-light: #ffffff; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: var(--bg-dark); color: var(--text-light); 
            font-family: 'Outfit', sans-serif; overflow: hidden; 
        }

        .header-back {
            position: fixed; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            padding: 10px 18px; border-radius: 50px; text-decoration: none;
            color: white; font-weight: 500; font-size: 15px;
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.15);
        }

        .feed-container {
            height: 100vh; height: 100dvh; width: 100%;
            overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth;
        }
        .feed-container::-webkit-scrollbar { display: none; } 

        .feed-item {
            height: 100vh; height: 100dvh; width: 100%;
            scroll-snap-align: start; scroll-snap-stop: always; 
            position: relative; background: #050505;
        }

        .video-section { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .player-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; background: #000;}

        iframe, video {
            width: 100%; height: 100%; border: none; 
            object-fit: cover; pointer-events: none; 
        }

        .ig-iframe { 
            pointer-events: auto !important; width: 100%; height: 100%; 
            max-width: 500px; background: #000;
        }

        .glass-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        /* --- FIXED LOADING SPINNER --- */
        .yt-spinner {
            width: 45px; height: 45px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--vlc-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%; left: 50%;
            margin-top: -22.5px; margin-left: -22.5px; /* Perfectly centered */
            z-index: 999;
            display: none; 
            pointer-events: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .center-icon {
            width: 70px; height: 70px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.8); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transform: scale(0.5); transition: 0.2s ease-out;
            position: absolute; top: 50%; left: 50%; margin-top: -35px; margin-left: -35px;
        }
        .center-icon.show { opacity: 1; transform: scale(1); }
        .center-icon svg { width: 35px; height: 35px; fill: white; }
        
        .error-text { font-size: 11px; font-weight: 600; text-align: center; line-height: 1.2; color: #ff4d4d; }

        .heart-icon {
            position: absolute; font-size: 80px; color: #e74c3c;
            opacity: 0; transform: scale(0); z-index: 20;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        @keyframes heartPop { 0% { transform: scale(0); opacity: 0; } 15% { transform: scale(1.2); opacity: 1; } 30% { transform: scale(1); opacity: 1; } 80% { transform: scale(1); opacity: 1; transform: translateY(0); } 100% { transform: scale(1.5) translateY(-50px); opacity: 0; } }
        .heart-animating { animation: heartPop 1s forwards; }

        .info-section { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 60%, transparent 100%); padding: 80px 20px 30px 20px; box-sizing: border-box; z-index: 20; pointer-events: none; }
        .vid-title { font-family: 'Outfit', sans-serif; font-size: 20px; font-weight: 700; color: #ffffff; margin: 0 0 8px 0; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .vid-desc { font-size: 14px; opacity: 0.9; line-height: 1.5; text-shadow: 0 1px 4px rgba(0,0,0,0.8); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .vlc-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; display: flex; align-items: flex-end; z-index: 30; cursor: pointer; }
        .vlc-progress { width: 100%; height: 3px; background: rgba(255,255,255,0.3); transition: height 0.1s; }
        .vlc-progress-container:active .vlc-progress { height: 8px; }
        .vlc-progress-bar { height: 100%; background: var(--vlc-orange); width: 0%; pointer-events: none; position: relative; }
        .vlc-progress-bar::after { content: ''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s; }
        .vlc-progress-container:active .vlc-progress-bar::after { opacity: 1; }
    </style>
</head>
<body>

    <a href="index.html" class="header-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back
    </a>

    <div class="feed-container" id="feed-container"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="data.js"></script>
    <script>
        const feedContainer = document.getElementById('feed-container');
        let ytPlayers = {}; 
        let htmlPlayers = {}; 
        let playState = {}; 

        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getInstagramEmbed(url) {
            if (url.includes('instagram.com')) {
                return url.split('?')[0].replace(/\/$/, "") + "/embed";
            }
            return null;
        }

        let feedVideos = [];
        if (typeof db !== 'undefined' && db.videos) {
            feedVideos = [...db.videos];
            const urlParams = new URLSearchParams(window.location.search);
            const reqId = parseInt(urlParams.get('id'));
            
            if(reqId) {
                const targetIdx = feedVideos.findIndex(v => v.id === reqId);
                if(targetIdx > -1) {
                    const targetVid = feedVideos.splice(targetIdx, 1)[0];
                    feedVideos.unshift(targetVid); 
                }
            }
        }

        if (feedVideos.length === 0) {
            feedContainer.innerHTML = `<div style="text-align:center; padding-top:40vh; font-size:20px;">No videos found.</div>`;
        } else {
            let htmlContent = '';
            feedVideos.forEach((video) => {
                const ytId = getYouTubeId(video.link);
                const igUrl = getInstagramEmbed(video.link);
                const isYt = !!ytId;
                const isIg = !!igUrl;
                const safeDesc = "Experience this amazing moment from the Mundari Samaj community. Scroll down for more!";
                
                const posterAttr = (video.thumbnail && video.thumbnail.trim() !== '') ? `poster="${video.thumbnail}"` : '';

                // ADDED type="video/mp4" and webkit-playsinline for strict mobile browsers
                htmlContent += `
                <div class="feed-item" data-id="vid_${video.id}" data-yt="${isYt}" data-ig="${isIg}">
                    <div class="video-section">
                        <div class="player-wrapper">
                            ${isYt 
                                ? `<iframe id="ytplayer_${video.id}" class="yt-iframe" src="https://www.youtube.com/embed/${ytId}?enablejsapi=1&autoplay=0&controls=0&disablekb=1&fs=0&modestbranding=1&rel=0&showinfo=0&playsinline=1&iv_load_policy=3" allow="autoplay; encrypted-media"></iframe>` 
                                : isIg 
                                ? `<iframe id="igplayer_${video.id}" class="ig-iframe" src="${igUrl}" frameborder="0" scrolling="no" allowtransparency="true" sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>`
                                : `<video id="htmlplayer_${video.id}" src="${video.link}" type="video/mp4" ${posterAttr} loop playsinline webkit-playsinline preload="metadata"></video>`
                            }
                            
                            <div class="yt-spinner" id="spinner_${video.id}"></div>

                            ${!isIg ? `
                            <div class="glass-overlay" id="overlay_${video.id}" onclick="handleTap('${video.id}', ${isYt})">
                                <div class="heart-icon" id="heart_${video.id}">❤️</div>
                                <div class="center-icon" id="icon_${video.id}">
                                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="info-section" style="${isIg ? 'pointer-events: none; opacity: 0.8;' : ''}">
                        <h2 class="vid-title">${video.title || 'Mundari Video'}</h2>
                        <div class="vid-desc">${safeDesc}</div>
                    </div>

                    ${!isIg ? `
                    <div class="vlc-progress-container" id="progContainer_${video.id}" onclick="seekVideo(event, '${video.id}', ${isYt})" ontouchmove="seekVideo(event, '${video.id}', ${isYt})">
                        <div class="vlc-progress"><div class="vlc-progress-bar" id="progress_${video.id}"></div></div>
                    </div>
                    ` : ''}
                </div>`;
            });
            feedContainer.innerHTML = htmlContent;
        }

        // Initialize Native HTML5 Players and their Spinners
        document.querySelectorAll('video').forEach(el => {
            const dbId = el.id.split('_')[1];
            htmlPlayers[dbId] = el;
            
            el.addEventListener('timeupdate', () => {
                if(el.duration) {
                    const progress = (el.currentTime / el.duration) * 100;
                    document.getElementById(`progress_${dbId}`).style.width = progress + '%';
                }
            });

            // SPINNER LOGIC: Accurately detects loading buffers!
            const spinner = document.getElementById(`spinner_${dbId}`);
            el.addEventListener('loadstart', () => { if(spinner) spinner.style.display = 'block'; });
            el.addEventListener('waiting', () => { if(spinner) spinner.style.display = 'block'; });
            el.addEventListener('playing', () => { if(spinner) spinner.style.display = 'none'; });
            el.addEventListener('canplay', () => { if(spinner) spinner.style.display = 'none'; });
            
            // SMART ERROR FALLBACK: If Catbox server fails or blocks the request
            el.addEventListener('error', () => {
                if(spinner) spinner.style.display = 'none';
                const icon = document.getElementById(`icon_${dbId}`);
                if(icon) {
                    icon.innerHTML = `<div class="error-text">Server Error<br>Tap to Open</div>`;
                    icon.style.borderColor = "#ff4d4d";
                    icon.classList.add('show');
                }
                el.dataset.error = "true";
            });
        });

        // Initialize YT Players
        function onYouTubeIframeAPIReady() {
            document.querySelectorAll('.yt-iframe').forEach(el => {
                const dbId = el.id.split('_')[1];
                ytPlayers[dbId] = new YT.Player(el.id, {
                    events: {
                        'onStateChange': function(event) {
                            const spinner = document.getElementById(`spinner_${dbId}`);
                            if (!spinner) return;
                            if (event.data == 3) { spinner.style.display = 'block'; } 
                            else if (event.data == 1 || event.data == 2) { spinner.style.display = 'none'; }
                        }
                    }
                });
            });
        }

        setInterval(() => {
            for (let id in playState) {
                if (playState[id] && ytPlayers[id] && typeof ytPlayers[id].getCurrentTime === 'function') {
                    const duration = ytPlayers[id].getDuration();
                    if (duration > 0) {
                        const prog = (ytPlayers[id].getCurrentTime() / duration) * 100;
                        document.getElementById(`progress_${id}`).style.width = prog + '%';
                    }
                }
            }
        }, 150);

        function seekVideo(e, id, isYt) {
            e.stopPropagation(); 
            const container = document.getElementById(`progContainer_${id}`);
            const rect = container.getBoundingClientRect();
            let clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            if(e.type === 'touchmove') e.preventDefault(); 

            let percentage = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width)); 
            document.getElementById(`progress_${id}`).style.width = (percentage * 100) + '%';
            
            if (isYt && ytPlayers[id] && typeof ytPlayers[id].getDuration === 'function') {
                ytPlayers[id].seekTo(percentage * ytPlayers[id].getDuration(), true);
            } else if (!isYt && htmlPlayers[id] && htmlPlayers[id].duration) {
                htmlPlayers[id].currentTime = percentage * htmlPlayers[id].duration;
            }
        }

        let lastTapTime = 0;

        function handleTap(id, isYt) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;

            if (tapLength < 300 && tapLength > 0) {
                const heart = document.getElementById(`heart_${id}`);
                heart.classList.remove('heart-animating');
                void heart.offsetWidth; 
                heart.classList.add('heart-animating');
            } else {
                togglePlay(id, isYt);
            }
            lastTapTime = currentTime;
        }

        function togglePlay(id, isYt) {
            if (playState[id]) forcePause(id, isYt);
            else forcePlay(id, isYt);
        }

        function forcePlay(id, isYt) {
            playState[id] = true;
            const icon = document.getElementById(`icon_${id}`);
            icon.classList.remove('show');
            const spinner = document.getElementById(`spinner_${id}`);
            
            if (isYt) {
                if (spinner) spinner.style.display = 'block'; 
                if (ytPlayers[id] && typeof ytPlayers[id].playVideo === 'function') {
                    ytPlayers[id].playVideo();
                } else {
                    const iframe = document.getElementById(`ytplayer_${id}`);
                    if(iframe) iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                }
            } else if (htmlPlayers[id]) {
                const vid = htmlPlayers[id];
                
                // ERROR FALLBACK: If video failed to load, open directly in new tab!
                if (vid.dataset.error === "true") {
                    window.open(vid.src, '_blank');
                    playState[id] = false;
                    return;
                }

                if (vid.readyState < 3 && spinner) {
                    spinner.style.display = 'block';
                }
                
                const playPromise = vid.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Successfully playing!
                    }).catch(error => {
                        // BROWSER BLOCKED AUTO-PLAY! Fallback smoothly to Play Button
                        playState[id] = false;
                        if (spinner) spinner.style.display = 'none';
                        icon.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
                        icon.classList.add('show');
                    });
                }
            }
        }

        function forcePause(id, isYt) {
            playState[id] = false;
            document.getElementById(`icon_${id}`).innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            document.getElementById(`icon_${id}`).classList.add('show');
            if (isYt) {
                const iframe = document.getElementById(`ytplayer_${id}`);
                if(iframe) iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            } else if (htmlPlayers[id]) {
                htmlPlayers[id].pause();
            }
        }

        // FULL AUTO-PLAY SYSTEM
        const feedObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.dataset.id.replace('vid_', '');
                const isYt = entry.target.dataset.yt === 'true';
                const isIg = entry.target.dataset.ig === 'true';

                if (isIg) return; 

                if (entry.isIntersecting) {
                    // Force play instantly when video enters the screen!
                    forcePlay(id, isYt);
                } else {
                    forcePause(id, isYt);
                }
            });
        }, { root: feedContainer, threshold: 0.6 });

        document.querySelectorAll('.feed-item').forEach(item => feedObserver.observe(item));

    </script>
</body>
</html>